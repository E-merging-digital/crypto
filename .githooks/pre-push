#!/usr/bin/env bash
set -euo pipefail

echo ">>> [pre-push] starting…"

# 1) Exiger DDEV démarré (on exécute tout dedans)
if ! command -v ddev >/dev/null 2>&1; then
  echo ">>> [pre-push] ddev introuvable. Installez DDEV et lancez 'ddev start'." >&2
  exit 1
fi
if ! ddev describe >/dev/null 2>&1; then
  echo ">>> [pre-push] Le projet DDEV n'est pas démarré. Lancez 'ddev start'." >&2
  exit 1
fi

# 2) PHPUnit complet via GrumPHP (testsuite pre-push) - DANS DDEV
echo ">>> [pre-push] GrumPHP testsuite: pre-push (PHPUnit complet)"
ddev exec -- ./vendor/bin/grumphp run --testsuite pre-push

# 3) Vérifier que Selenium (service ddev 'selenium') est prêt
echo ">>> [pre-push] Vérification Selenium (service ddev 'selenium')…"
ddev exec -- bash -lc 'for i in {1..60}; do curl -fsS http://selenium:4444/status | grep -q "\"ready\"[[:space:]]*:[[:space:]]*true" && exit 0; sleep 1; done; exit 1'

# 4) Behat dans DDEV avec le profil 'ddev' (base_url=http://web)
echo ">>> [pre-push] Behat (profil: ddev)"
ddev exec -- ./vendor/bin/behat -c behat.yml -p ddev --colors --strict
