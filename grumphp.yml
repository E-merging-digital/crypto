grumphp:
  hooks_preset: local
  process_timeout: 900
  parallel:
    enabled: true

  tasks:
    # ✅ Composer validate + PHPUnit (Unit) en pré-commit via shell
    shell:
      scripts:
        - ['composer', 'validate', '--strict', '--no-check-publish', '--no-interaction']
        - ['bash', '-lc', 'test -x ./vendor/bin/phpunit && ./vendor/bin/phpunit --testsuite Unit || echo "PHPUnit not installed, skipping Unit suite."']

    # ✅ PHPCS (Drupal standards via phpcs.xml.dist)
    phpcs:
      standard: 'phpcs.xml.dist'
      ignore_patterns:
        - '/vendor/*'
        - '/web/core/*'
        - '/web/modules/contrib/*'
        - '/web/themes/contrib/*'
      triggered_by: [php, module, inc, install, profile, theme, engine]

    # ✅ PHPStan
    phpstan:
      configuration: 'phpstan.neon'
      memory_limit: '-1'

    # ✅ PHPUnit complet (appelé par la testsuite pre-push)
    phpunit:
      config_file: 'phpunit.xml.dist'
      always_execute: true

    # ✅ TwigCS — utiliser "ruleset" (et non "config")
    twigcs:
      ruleset: 'official'
      triggered_by: [twig]
      # (optionnel) vous pouvez préciser un chemin racine :
      # path: 'web'

    # ✅ Lint JSON & XML
    jsonlint:
      detect_key_conflicts: true
      triggered_by: [json]
      ignore_patterns:
        - '/vendor/*'

    xmllint:
      triggered_by: [xml]
      ignore_patterns:
        - '/vendor/*'

  testsuites:
    pre-commit:
      tasks:
        - shell
        - phpcs
        - phpstan
        - twigcs
        - jsonlint
        - xmllint

    pre-push:
      tasks:
        - phpunit
