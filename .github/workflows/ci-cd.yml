name: CI/CD Drupal 11 â€“ crypto

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

defaults:
  run:
    shell: bash

env:
  COMPOSER_PROCESS_TIMEOUT: 1200
  COMPOSER_MEMORY_LIMIT: -1

jobs:
  phpunit-and-lint:
    name: PhpUnit & lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Mark workspace safe for git
        run: git config --global --add safe.directory "${{ github.workspace }}"

      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none
          extensions: xml, gd, mysqli, zip, gmp
          tools: composer

      - name: Show loaded PHP modules (debug)
        run: php -m | head -n 200

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install project dependencies
        run: composer install --prefer-dist --no-interaction --optimize-autoloader

      - name: Prepare Drupal test output directories
        run: |
          mkdir -p web/sites/simpletest/browser_output
          chmod -R 775 web/sites/simpletest

      - name: Ensure run-tests.sh is executable
        run: test -f scripts/run-tests.sh && chmod +x scripts/run-tests.sh || true

      - name: Add vendor/bin to PATH
        run: echo "${GITHUB_WORKSPACE}/vendor/bin" >> "$GITHUB_PATH"

      - name: Run GrumPHP (lint + static analysis + PHPUnit)
        env:
          SIMPLETEST_BASE_URL: http://127.0.0.1:8080
          SIMPLETEST_DB: sqlite://localhost/web/sites/default/files/.ht.sqlite
          BROWSERTEST_OUTPUT_DIRECTORY: web/sites/simpletest/browser_output
        run: grumphp run

  behat:
    name: Behat end-to-end tests
    runs-on: ubuntu-latest
    needs: phpunit-and-lint

    container:
      image: ghcr.io/e-merging-digital/crypto:php8.3-gd-gmp-git
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    services:
      web:
        image: ghcr.io/e-merging-digital/crypto:php8.3-gd-gmp-git
        options: >-
          -v ${{ github.workspace }}:/var/www/html:rw
      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444
        options: >-
          --shm-size="2g"
          --health-cmd="curl -s http://localhost:4444/status | grep -q 'ready'"
          --health-interval=5s --health-timeout=5s --health-retries=30
          -e SE_NODE_MAX_SESSIONS=1
          -e SE_NODE_SESSION_TIMEOUT=300
      # MariaDB facultatif (non utilisÃ© par les tests ci-dessous, conservÃ© pour la structure)
      db:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: ci_crypto
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot --silent"
          --health-interval=5s --health-timeout=5s --health-retries=30

    steps:
      - uses: actions/checkout@v4

      - name: Mark workspace safe
        run: git config --global --add safe.directory "${{ github.workspace }}"

      - name: Sanity check shell & PATH
        run: |
          command -v bash
          echo "PATH=$PATH"

      - name: Cache Composer (in container)
        uses: actions/cache@v4
        with:
          path: |
            /github/home/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dev dependencies
        run: composer install --prefer-dist --no-interaction --optimize-autoloader

      - name: Add vendor/bin to PATH
        run: echo "${GITHUB_WORKSPACE}/vendor/bin" >> "$GITHUB_PATH"

      # ---- [JOB CONTAINER] Mise Ã  niveau SQLite >= 3.45 + extension PHP sqlite3
      - name: Upgrade SQLite (job container) & ensure php-sqlite3
        run: |
          set -e
          . /etc/os-release
          echo "deb http://deb.debian.org/debian ${VERSION_CODENAME}-backports main" > /etc/apt/sources.list.d/backports.list
          apt-get update -y
          DEBIAN_FRONTEND=noninteractive apt-get -y -t ${VERSION_CODENAME}-backports install libsqlite3-0 sqlite3 || true
          # Installer l'extension PHP sqlite3 si absente (8.3, 8.2 ou gÃ©nÃ©rique)
          if ! php -m | grep -qi sqlite3; then
            if apt-cache show php8.3-sqlite3 >/dev/null 2>&1; then
              DEBIAN_FRONTEND=noninteractive apt-get install -y php8.3-sqlite3
            elif apt-cache show php8.2-sqlite3 >/dev/null 2>&1; then
              DEBIAN_FRONTEND=noninteractive apt-get install -y php8.2-sqlite3
            else
              DEBIAN_FRONTEND=noninteractive apt-get install -y php-sqlite3 || true
            fi
          fi
          echo "sqlite3 CLI version:"; sqlite3 --version || true
          echo "PHP SQLite3 lib version:"
          php -r 'echo (class_exists("SQLite3")? (SQLite3::version()["lib"]??"n/a") : "no-sqlite3-ext"), PHP_EOL;'

      # ---- [SERVICE WEB] Mise Ã  niveau SQLite >= 3.45 + extension PHP sqlite3
      - name: Upgrade SQLite (web service) & ensure php-sqlite3
        run: |
          set -e
          WEB_CID="$(docker ps -aqf "name=web")"
          if [ -z "$WEB_CID" ]; then echo "Web service container not found"; exit 1; fi
          docker exec "$WEB_CID" bash -lc '
            set -e
            . /etc/os-release
            echo "deb http://deb.debian.org/debian ${VERSION_CODENAME}-backports main" > /etc/apt/sources.list.d/backports.list
            apt-get update -y
            DEBIAN_FRONTEND=noninteractive apt-get -y -t ${VERSION_CODENAME}-backports install libsqlite3-0 sqlite3 || true
            if ! php -m | grep -qi sqlite3; then
              if apt-cache show php8.3-sqlite3 >/dev/null 2>&1; then
                DEBIAN_FRONTEND=noninteractive apt-get install -y php8.3-sqlite3
              elif apt-cache show php8.2-sqlite3 >/dev/null 2>&1; then
                DEBIAN_FRONTEND=noninteractive apt-get install -y php8.2-sqlite3
              else
                DEBIAN_FRONTEND=noninteractive apt-get install -y php-sqlite3 || true
              fi
            fi
            echo "sqlite3 CLI version:"; sqlite3 --version || true
            echo "PHP SQLite3 lib version:"; php -r "echo (class_exists(\"SQLite3\")? (SQLite3::version()[\"lib\"]??\"n/a\") : \"no-sqlite3-ext\"), PHP_EOL;"
            (command -v apache2ctl && apache2ctl -k graceful) || (command -v service && service apache2 reload) || true
          '

      # PrÃ©parer settings.php pour SQLite (api_driver BrowserKit/Drupal OK)
      - name: Prepare Drupal settings.php for CI (SQLite)
        run: |
          set -e
          cp web/sites/default/default.settings.php web/sites/default/settings.php
          {
            echo ""
            echo "\$databases['default']['default'] = ["
            echo "  'driver' => 'sqlite',"
            echo "  'database' => __DIR__ . '/files/.ht.sqlite',"
            echo "  'prefix' => '',"
            echo "];"
            echo "\$settings['hash_salt'] = 'ci-auto-generated-salt';"
            echo "\$settings['trusted_host_patterns'][] = '^web$';"
          } >> web/sites/default/settings.php
          mkdir -p web/sites/default/files
          chmod -R 777 web/sites/default/files
          php -r 'file_exists("web/sites/default/files/.ht.sqlite") || touch("web/sites/default/files/.ht.sqlite");'

      # Installer Drupal (SQLite) pour Ã©viter 403 et avoir un site prÃªt pour Behat
      - name: Install Drupal (SQLite) via Drush
        working-directory: web
        run: |
          ../vendor/bin/drush si minimal -y --db-url=sqlite://sites/default/files/.ht.sqlite --site-name="CI Crypto" --account-name=admin --account-pass=admin
          ../vendor/bin/drush cr

      - name: Install curl & jq in job container
        run: |
          if ! command -v curl >/dev/null 2>&1 || ! command -v jq >/dev/null 2>&1; then
            apt-get update -y
            DEBIAN_FRONTEND=noninteractive apt-get install -y curl jq
          fi

      - name: Wait for Selenium service (robust)
        run: |
          set -euo pipefail
          ATTEMPTS=120
          for i in $(seq 1 $ATTEMPTS); do
            if curl -fsS http://selenium:4444/status | jq -e '.ready == true' >/dev/null 2>&1; then
              echo "Selenium ready via /status"; exit 0
            fi
            if curl -fsS http://selenium:4444/wd/hub/status | jq -e '.value.ready == true' >/dev/null 2>&1; then
              echo "Selenium ready via /wd/hub/status"; exit 0
            fi
            echo "Waiting Selenium... ($i/$ATTEMPTS)"
            sleep 2
          done
          echo "Selenium did not become ready in time."
          exit 1

      - name: Wait for web service (TCP check)
        run: |
          set -euo pipefail
          ATTEMPTS=60
          for i in $(seq 1 $ATTEMPTS); do
            if curl -s --max-time 2 http://web/ >/dev/null 2>&1; then
              echo "Web reachable"; exit 0
            fi
            echo "Waiting Web... ($i/$ATTEMPTS)"
            sleep 2
          done
          echo "Web did not become reachable in time."
          exit 1

      # ðŸ”Ž VÃ©rification demandÃ©e (pipe exact)
      - name: Verify FeatureContext autoload
        run: |
          php -r 'require "vendor/autoload.php"; echo (class_exists("App\\Tests\\Behat\\FeatureContext") ? "OK": "MISSING"), PHP_EOL;'

      - name: Run Behat (profil CI)
        run: vendor/bin/behat -c behat.yml -p ci --colors --strict

      - name: Dump Selenium logs on failure
        if: failure()
        run: |
          echo "=== Selenium logs ==="
          docker logs "$(docker ps -aqf "name=selenium")" || true
      - name: Dump Web logs on failure
        if: failure()
        run: |
          echo "=== Apache access/error logs (if available) ==="
          docker exec "$(docker ps -aqf "name=web")" bash -lc 'tail -n 200 /var/log/apache2/error.log 2>/dev/null || true; tail -n 200 /var/log/apache2/access.log 2>/dev/null || true' || true

  deploy:
    name: DÃ©ploiement (Ã  adapter selon lâ€™environnement)
    runs-on: ubuntu-latest
    needs: [phpunit-and-lint, behat]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH for private deploy
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: composer

      - name: Composer install for deploy (no dev)
        run: composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: Build theme assets (si thÃ¨me custom existe)
        working-directory: web/themes/custom
        run: |
          if [ -f package.json ]; then npm ci && npm run build; else echo "No theme build"; fi

      - name: Push sur le repo de production
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub CI"
          git remote add production ${{ secrets.PRODUCTION_SSH_REPO }}
          git push production main:main --force-with-lease

      - name: Run Drush post-deploy
        env:
          PROD_SSH: ${{ secrets.PROD_SSH }}
        run: |
          ssh -o StrictHostKeyChecking=no "$PROD_SSH" \
            "cd web && vendor/bin/drush cim -y && vendor/bin/drush updb -y && vendor/bin/drush cr"
