name: CI/CD Drupal 11 – crypto

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# 1) Toujours exécuter sous bash
defaults:
  run:
    shell: bash

# 2) Variables globales stables (ne PAS définir PATH ici pour éviter tout écrasement)
env:
  COMPOSER_PROCESS_TIMEOUT: 1200
  COMPOSER_MEMORY_LIMIT: -1

jobs:
  phpunit-and-lint:
    name: PhpUnit & lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Mark workspace safe for git
        run: git config --global --add safe.directory "${{ github.workspace }}"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none
          extensions: xml, gd, mysqli, zip, gmp
          tools: composer

      - name: Show loaded PHP modules (debug)
        run: php -m | head -n 200

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install project dependencies
        run: |
          composer install --prefer-dist --no-interaction --optimize-autoloader

      - name: Prepare Drupal test output directories
        run: |
          mkdir -p web/sites/simpletest/browser_output
          chmod -R 775 web/sites/simpletest

      - name: Ensure run-tests.sh is executable
        run: chmod +x scripts/run-tests.sh

      # On ajoute vendor/bin au PATH proprement (sans l'écraser)
      - name: Add vendor/bin to PATH
        run: echo "${GITHUB_WORKSPACE}/vendor/bin" >> "$GITHUB_PATH"

      - name: Run GrumPHP (lint + static analysis + PHPUnit)
        env:
          SIMPLETEST_BASE_URL: http://127.0.0.1:8080
          SIMPLETEST_DB: sqlite://localhost/web/sites/default/files/.ht.sqlite
          BROWSERTEST_OUTPUT_DIRECTORY: web/sites/simpletest/browser_output
        run: grumphp run

  behat:
    name: Behat end-to-end tests
    runs-on: ubuntu-latest
    needs: phpunit-and-lint
    container:
      image: ghcr.io/e-merging-digital/crypto:php8.3-gd-gmp-git
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Mark workspace safe
        run: git config --global --add safe.directory "${{ github.workspace }}"

      - name: Sanity check shell & PATH (debug)
        run: |
          command -v bash
          echo "PATH=$PATH"

      - name: Cache Composer (in container)
        uses: actions/cache@v4
        with:
          path: |
            /github/home/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dev dependencies
        run: composer install --prefer-dist --no-interaction --optimize-autoloader

      - name: Add vendor/bin to PATH
        run: echo "${GITHUB_WORKSPACE}/vendor/bin" >> "$GITHUB_PATH"

      # IMPORTANT : on n'installe plus behat ici s'il est déjà en require-dev.
      # Gardez cette étape *uniquement* si vous n’avez pas modifié composer.json :
      # - name: Setup Behat extensions (legacy)
      #   run: composer require --dev behat/behat behat/mink-extension drupal/drupal-extension behat/mink-selenium2-driver

      - name: Dump autoload (au cas où)
        run: composer dump-autoload -o

      - name: Verify FeatureContext autoload
        run: |
          php -r 'require "vendor/autoload.php"; echo (class_exists("App\\\\Tests\\\\Behat\\\\FeatureContext") ? "OK" : "MISSING") . PHP_EOL;'

      # Lancer Behat depuis la racine (où se trouve behat.yml)
      - name: Run Behat
        run: behat --colors --strict --out formats

  deploy:
    name: Déploiement (à adapter selon l’environnement)
    runs-on: ubuntu-latest
    needs: [phpunit-and-lint, behat]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH for private deploy
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: composer

      - name: Composer install for deploy (no dev)
        run: |
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: Build theme assets (si thème custom existe)
        working-directory: web/themes/custom
        run: |
          npm ci
          npm run build

      - name: Push sur le repo de production
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub CI"
          git remote add production ${{ secrets.PRODUCTION_SSH_REPO }}
          git push production main:main --force-with-lease

      - name: Run Drush post-deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_SSH }} \
            "cd web && vendor/bin/drush cim -y && vendor/bin/drush updb -y && vendor/bin/drush cr"
